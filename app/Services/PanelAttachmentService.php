<?php

namespace App\Services;

use App\Models\PanelAttachment;
use App\Support\Interfaces\Services\SerialPanelServiceInterface;
use App\Support\Interfaces\Services\PanelAttachmentServiceInterface;
use App\Support\Interfaces\Repositories\PanelAttachmentRepositoryInterface;
use App\Support\Interfaces\Services\PanelAttachmentHandlerServiceInterface;
use Adobrovolsky97\LaravelRepositoryServicePattern\Services\BaseCrudService;
use App\Http\Resources\PanelAttachmentResource;
use App\Support\Enums\PanelAttachmentStatusEnum;

class PanelAttachmentService extends BaseCrudService implements PanelAttachmentServiceInterface
{
    public function __construct(
        protected PanelAttachmentHandlerServiceInterface $panelAttachmentHandlerService,
        protected SerialPanelServiceInterface $serialPanelService,
    ) {
        parent::__construct();
    }

    public function delete($keyOrModel): bool
    {
        $keyOrModel->panel_attachment_handlers()->each(function ($panelAttachmentHandler) {
            $this->panelAttachmentHandlerService->delete($panelAttachmentHandler);
        });

        $keyOrModel->serial_panels()->each(function ($serialPanel) {
            $this->serialPanelService->delete($serialPanel);
        });

        return parent::delete($keyOrModel); // TODO: Change the autogenerated stub
    }

    protected function getRepositoryClass(): string
    {
        return PanelAttachmentRepositoryInterface::class;
    }

    public function confirmKPM($panelAttachment, $request)
    {
        $panelAttachment = PanelAttachment::find($panelAttachment);

        $panelAttachment->status = PanelAttachmentStatusEnum::MATERIAL_ACCEPTED->value;

        $panelAttachment->save();

        return PanelAttachmentResource::make($panelAttachment);
    }
}
